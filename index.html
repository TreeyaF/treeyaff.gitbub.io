<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCM Blurb ææŠ¥ - ååŒåˆä½œç‰ˆ</title>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .sync-buttons {
            margin-top: 15px;
        }
        .btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn:hover { background: #059669; }
        .btn-blue { background: #6366f1; }
        .btn-blue:hover { background: #4f46e5; }
        
        .nav-tabs { display: flex; background: #f8f9fa; }
        .nav-tab { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: #f8f9fa; 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
        }
        .nav-tab.active { 
            background: white; 
            border-bottom-color: #007bff; 
        }
        .tab-content { 
            display: none; 
            padding: 20px; 
            min-height: 500px;
        }
        .tab-content.active { display: block; }
        
        .status-success { 
            background: #d1fae5; 
            color: #065f46; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        .status-error { 
            background: #fee2e2; 
            color: #991b1b; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OCM Blurb ææŠ¥ - ååŒåˆä½œç‰ˆ</h1>
            <p>æ”¯æŒå¤šäººå®æ—¶åä½œçš„Mass Communityç®¡ç†å¹³å°</p>
            <div id="collabStatus" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 14px;">
                ğŸ”„ ååŒåŠŸèƒ½å¯åŠ¨ä¸­...
            </div>
            <div class="sync-buttons">
                <button class="btn" onclick="manualSync()">ğŸ”„ æ‰‹åŠ¨åŒæ­¥æ•°æ®</button>
                <button class="btn btn-blue" onclick="showDebug()">ğŸ” æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
                <button class="btn btn-blue" onclick="testConnection()">ğŸ§ª æµ‹è¯•è¿æ¥</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('calendar')">å‘é€æ—¥å†</button>
            <button class="nav-tab" onclick="showTab('admin')">ç®¡ç†å‘˜å®¡æ ¸</button>
            <button class="nav-tab" onclick="showTab('records')">å®¡æ ¸è®°å½•</button>
        </div>

        <div id="calendar" class="tab-content active">
            <h2>ğŸ“… æ—¥å†è§†å›¾</h2>
            <div id="calendarDisplay">
                <p>æ—¥å†åŠ è½½ä¸­...</p>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <h2>ğŸ‘¥ ç®¡ç†å‘˜å®¡æ ¸</h2>
            <div id="pendingRequests">
                <p>åŠ è½½å¾…å®¡æ ¸è¯·æ±‚ä¸­...</p>
            </div>
        </div>

        <div id="records" class="tab-content">
            <h2>ğŸ“Š å®¡æ ¸è®°å½•</h2>
            <div id="approvedEvents">
                <p>åŠ è½½å®¡æ ¸è®°å½•ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let requests = [];
        let approvedEvents = [];
        let supabase = null;
        let collaborationEnabled = false;

        // Supabaseé…ç½®
        const SUPABASE_CONFIG = {
            url: 'https://omgtzyavksgyemigxuwj.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tZ3R6eWF2a3NneWVtaWd4dXdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTA5ODgsImV4cCI6MjA3MDAyNjk4OH0.7F2VEtLYvOggT25fb6vD6fqoBmC2KJfdqLjSSNVL6lU'
        };

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('collabStatus');
            const colors = {
                success: 'rgba(16, 185, 129, 0.3)',
                error: 'rgba(239, 68, 68, 0.3)',
                info: 'rgba(59, 130, 246, 0.3)'
            };
            
            if (statusDiv) {
                statusDiv.style.background = colors[type];
                statusDiv.innerHTML = message;
            }
            console.log(`[STATUS] ${message}`);
        }

        // åˆå§‹åŒ–Supabase
        async function initSupabase() {
            try {
                console.log('[INIT] åˆå§‹åŒ–Supabase...');
                updateStatus('ğŸ”„ æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...');
                
                if (!window.supabase) {
                    throw new Error('Supabase SDKæœªåŠ è½½');
                }
                
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                collaborationEnabled = true;
                
                console.log('[INIT] Supabaseåˆå§‹åŒ–æˆåŠŸ');
                updateStatus('âœ… ååŒåŠŸèƒ½å·²å¯ç”¨ - æ”¯æŒå¤šäººå®æ—¶åä½œ', 'success');
                
                // è‡ªåŠ¨åŠ è½½æ•°æ®
                setTimeout(() => {
                    loadCloudData();
                }, 2000);
                
            } catch (error) {
                console.error('[INIT] Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('ğŸ’¾ æœ¬åœ°æ¨¡å¼ - åŠŸèƒ½æ­£å¸¸ï¼Œæ•°æ®ä¿å­˜åœ¨æœ¬åœ°', 'error');
                collaborationEnabled = false;
                
                // åŠ è½½æœ¬åœ°æ•°æ®
                loadLocalData();
            }
        }

        // åŠ è½½äº‘ç«¯æ•°æ®
        async function loadCloudData() {
            if (!collaborationEnabled || !supabase) {
                console.log('[CLOUD] ååŒåŠŸèƒ½æœªå¯ç”¨ï¼Œè·³è¿‡äº‘ç«¯åŠ è½½');
                return;
            }
            
            console.log('[CLOUD] å¼€å§‹åŠ è½½äº‘ç«¯æ•°æ®...');
            updateStatus('ğŸ”„ æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...');
            
            try {
                // åŠ è½½è¯·æ±‚æ•°æ®
                const { data: requestsData, error: requestsError } = await supabase
                    .from('requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (requestsError) {
                    throw requestsError;
                }
                
                console.log(`[CLOUD] åŠ è½½åˆ° ${requestsData.length} ä¸ªè¯·æ±‚`);
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                requests = requestsData.map(item => ({
                    id: item.id,
                    content: item.content,
                    arc: item.title.split(' - ')[0] || 'N/A',
                    cohort: item.title.split(' - ')[1] || 'N/A',
                    target: item.title.split(' - ')[2] || 'unknown',
                    sendDate: item.date,
                    submitter: item.contact,
                    teamDomain: item.location,
                    email: item.email,
                    status: item.status,
                    submitTime: new Date(item.created_at).toLocaleString('zh-CN')
                }));
                
                // åŠ è½½äº‹ä»¶æ•°æ®
                const { data: eventsData, error: eventsError } = await supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (eventsError) {
                    throw eventsError;
                }
                
                console.log(`[CLOUD] åŠ è½½åˆ° ${eventsData.length} ä¸ªäº‹ä»¶`);
                
                approvedEvents = eventsData.map(item => ({
                    id: item.id,
                    title: item.title,
                    date: item.date,
                    content: item.content,
                    submitter: item.contact,
                    arc: item.title.split(' - ')[0] || 'N/A',
                    cohort: item.title.split(' - ')[1] || 'N/A'
                }));
                
                updateStatus(`âœ… æ•°æ®åŒæ­¥å®Œæˆï¼åŠ è½½äº† ${requests.length} ä¸ªè¯·æ±‚å’Œ ${approvedEvents.length} ä¸ªäº‹ä»¶`, 'success');
                
                // æ›´æ–°ç•Œé¢
                updateDisplay();
                
            } catch (error) {
                console.error('[CLOUD] åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥:', error);
                updateStatus('âŒ äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                loadLocalData();
            }
        }

        // åŠ è½½æœ¬åœ°æ•°æ®
        function loadLocalData() {
            console.log('[LOCAL] åŠ è½½æœ¬åœ°æ•°æ®...');
            requests = JSON.parse(localStorage.getItem('massRequests') || '[]');
            approvedEvents = JSON.parse(localStorage.getItem('approvedEvents') || '[]');
            
            console.log(`[LOCAL] æœ¬åœ°è¯·æ±‚: ${requests.length} ä¸ª`);
            console.log(`[LOCAL] æœ¬åœ°äº‹ä»¶: ${approvedEvents.length} ä¸ª`);
            
            updateDisplay();
        }

        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
        function updateDisplay() {
            console.log('[DISPLAY] æ›´æ–°ç•Œé¢æ˜¾ç¤º...');
            
            // æ›´æ–°æ—¥å†
            const calendarDiv = document.getElementById('calendarDisplay');
            if (approvedEvents.length > 0) {
                let html = '<h3>ğŸ“… å·²æ‰¹å‡†çš„äº‹ä»¶:</h3>';
                approvedEvents.forEach(event => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>${event.title}</strong><br>
                            æ—¥æœŸ: ${event.date}<br>
                            å†…å®¹: ${event.content}
                        </div>
                    `;
                });
                calendarDiv.innerHTML = html;
            } else {
                calendarDiv.innerHTML = '<p>æš‚æ— å·²æ‰¹å‡†çš„äº‹ä»¶</p>';
            }
            
            // æ›´æ–°å¾…å®¡æ ¸è¯·æ±‚
            const pendingDiv = document.getElementById('pendingRequests');
            const pendingRequests = requests.filter(req => req.status === 'pending');
            
            if (pendingRequests.length > 0) {
                let html = '<h3>ğŸ“‹ å¾…å®¡æ ¸è¯·æ±‚:</h3>';
                pendingRequests.forEach(req => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>${req.arc} - ${req.cohort}</strong><br>
                            å†…å®¹: ${req.content}<br>
                            æäº¤æ—¶é—´: ${req.submitTime}<br>
                            <button class="btn" onclick="approveRequest('${req.id}')">âœ… æ‰¹å‡†</button>
                            <button class="btn" style="background: #ef4444;" onclick="rejectRequest('${req.id}')">âŒ æ‹’ç»</button>
                        </div>
                    `;
                });
                pendingDiv.innerHTML = html;
            } else {
                pendingDiv.innerHTML = '<p>æš‚æ— å¾…å®¡æ ¸è¯·æ±‚</p>';
            }
            
            // æ›´æ–°å®¡æ ¸è®°å½•
            const recordsDiv = document.getElementById('approvedEvents');
            const processedRequests = requests.filter(req => req.status !== 'pending');
            
            if (processedRequests.length > 0) {
                let html = '<h3>ğŸ“Š å®¡æ ¸è®°å½•:</h3>';
                processedRequests.forEach(req => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>${req.arc} - ${req.cohort}</strong><br>
                            çŠ¶æ€: ${req.status === 'approved' ? 'âœ… å·²æ‰¹å‡†' : 'âŒ å·²æ‹’ç»'}<br>
                            å†…å®¹: ${req.content}
                        </div>
                    `;
                });
                recordsDiv.innerHTML = html;
            } else {
                recordsDiv.innerHTML = '<p>æš‚æ— å®¡æ ¸è®°å½•</p>';
            }
        }

        // æ‰‹åŠ¨åŒæ­¥
        async function manualSync() {
            console.log('[MANUAL] æ‰‹åŠ¨åŒæ­¥è§¦å‘');
            updateStatus('ğŸ”„ æ­£åœ¨æ‰‹åŠ¨åŒæ­¥æ•°æ®...', 'info');
            
            if (collaborationEnabled) {
                await loadCloudData();
            } else {
                loadLocalData();
                updateStatus('ğŸ’¾ æœ¬åœ°æ•°æ®å·²åˆ·æ–°', 'info');
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebug() {
            const info = `
=== è°ƒè¯•ä¿¡æ¯ ===
ååŒåŠŸèƒ½: ${collaborationEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
Supabase: ${supabase ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
è¯·æ±‚æ•°é‡: ${requests.length}
äº‹ä»¶æ•°é‡: ${approvedEvents.length}
            `;
            
            console.log(info);
            alert(info);
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            if (!supabase) {
                alert('Supabaseæœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                const { data, error } = await supabase.from('requests').select('count').limit(1);
                if (error) throw error;
                alert('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼');
            } catch (error) {
                alert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æ‰¹å‡†è¯·æ±‚
        function approveRequest(id) {
            console.log(`[APPROVE] æ‰¹å‡†è¯·æ±‚: ${id}`);
            // è¿™é‡Œæ·»åŠ æ‰¹å‡†é€»è¾‘
            alert('æ‰¹å‡†åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // æ‹’ç»è¯·æ±‚
        function rejectRequest(id) {
            console.log(`[REJECT] æ‹’ç»è¯·æ±‚: ${id}`);
            // è¿™é‡Œæ·»åŠ æ‹’ç»é€»è¾‘
            alert('æ‹’ç»åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            console.log(`[TAB] åˆ‡æ¢åˆ°: ${tabName}`);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[PAGE] é¡µé¢å¼€å§‹åˆå§‹åŒ–');
            updateStatus('ğŸš€ æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...');
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                initSupabase();
            }, 1000);
        });
    </script>
</body>
</html>
