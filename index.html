<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCM Blurb 提报 - 协同合作版</title>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .sync-buttons {
            margin-top: 15px;
        }
        .btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn:hover { background: #059669; }
        .btn-blue { background: #6366f1; }
        .btn-blue:hover { background: #4f46e5; }
        
        .nav-tabs { display: flex; background: #f8f9fa; }
        .nav-tab { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: #f8f9fa; 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
        }
        .nav-tab.active { 
            background: white; 
            border-bottom-color: #007bff; 
        }
        .tab-content { 
            display: none; 
            padding: 20px; 
            min-height: 500px;
        }
        .tab-content.active { display: block; }
        
        .status-success { 
            background: #d1fae5; 
            color: #065f46; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        .status-error { 
            background: #fee2e2; 
            color: #991b1b; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OCM Blurb 提报 - 协同合作版</h1>
            <p>支持多人实时协作的Mass Community管理平台</p>
            <div id="collabStatus" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 14px;">
                🔄 协同功能启动中...
            </div>
            <div class="sync-buttons">
                <button class="btn" onclick="manualSync()">🔄 手动同步数据</button>
                <button class="btn btn-blue" onclick="showDebug()">🔍 显示调试信息</button>
                <button class="btn btn-blue" onclick="testConnection()">🧪 测试连接</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('calendar')">发送日历</button>
            <button class="nav-tab" onclick="showTab('admin')">管理员审核</button>
            <button class="nav-tab" onclick="showTab('records')">审核记录</button>
        </div>

        <div id="calendar" class="tab-content active">
            <h2>📅 日历视图</h2>
            <div id="calendarDisplay">
                <p>日历加载中...</p>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <h2>👥 管理员审核</h2>
            <div id="pendingRequests">
                <p>加载待审核请求中...</p>
            </div>
        </div>

        <div id="records" class="tab-content">
            <h2>📊 审核记录</h2>
            <div id="approvedEvents">
                <p>加载审核记录中...</p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let requests = [];
        let approvedEvents = [];
        let supabase = null;
        let collaborationEnabled = false;

        // Supabase配置
        const SUPABASE_CONFIG = {
            url: 'https://omgtzyavksgyemigxuwj.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tZ3R6eWF2a3NneWVtaWd4dXdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTA5ODgsImV4cCI6MjA3MDAyNjk4OH0.7F2VEtLYvOggT25fb6vD6fqoBmC2KJfdqLjSSNVL6lU'
        };

        // 更新状态显示
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('collabStatus');
            const colors = {
                success: 'rgba(16, 185, 129, 0.3)',
                error: 'rgba(239, 68, 68, 0.3)',
                info: 'rgba(59, 130, 246, 0.3)'
            };
            
            if (statusDiv) {
                statusDiv.style.background = colors[type];
                statusDiv.innerHTML = message;
            }
            console.log(`[STATUS] ${message}`);
        }

        // 初始化Supabase
        async function initSupabase() {
            try {
                console.log('[INIT] 初始化Supabase...');
                updateStatus('🔄 正在连接云端数据库...');
                
                if (!window.supabase) {
                    throw new Error('Supabase SDK未加载');
                }
                
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                collaborationEnabled = true;
                
                console.log('[INIT] Supabase初始化成功');
                updateStatus('✅ 协同功能已启用 - 支持多人实时协作', 'success');
                
                // 自动加载数据
                setTimeout(() => {
                    loadCloudData();
                }, 2000);
                
            } catch (error) {
                console.error('[INIT] Supabase初始化失败:', error);
                updateStatus('💾 本地模式 - 功能正常，数据保存在本地', 'error');
                collaborationEnabled = false;
                
                // 加载本地数据
                loadLocalData();
            }
        }

        // 加载云端数据
        async function loadCloudData() {
            if (!collaborationEnabled || !supabase) {
                console.log('[CLOUD] 协同功能未启用，跳过云端加载');
                return;
            }
            
            console.log('[CLOUD] 开始加载云端数据...');
            updateStatus('🔄 正在同步云端数据...');
            
            try {
                // 加载请求数据
                const { data: requestsData, error: requestsError } = await supabase
                    .from('requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (requestsError) {
                    throw requestsError;
                }
                
                console.log(`[CLOUD] 加载到 ${requestsData.length} 个请求`);
                
                // 转换数据格式
                requests = requestsData.map(item => ({
                    id: item.id,
                    content: item.content,
                    arc: item.title.split(' - ')[0] || 'N/A',
                    cohort: item.title.split(' - ')[1] || 'N/A',
                    target: item.title.split(' - ')[2] || 'unknown',
                    sendDate: item.date,
                    submitter: item.contact,
                    teamDomain: item.location,
                    email: item.email,
                    status: item.status,
                    submitTime: new Date(item.created_at).toLocaleString('zh-CN')
                }));
                
                // 加载事件数据
                const { data: eventsData, error: eventsError } = await supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (eventsError) {
                    throw eventsError;
                }
                
                console.log(`[CLOUD] 加载到 ${eventsData.length} 个事件`);
                
                approvedEvents = eventsData.map(item => ({
                    id: item.id,
                    title: item.title,
                    date: item.date,
                    content: item.content,
                    submitter: item.contact,
                    arc: item.title.split(' - ')[0] || 'N/A',
                    cohort: item.title.split(' - ')[1] || 'N/A'
                }));
                
                updateStatus(`✅ 数据同步完成！加载了 ${requests.length} 个请求和 ${approvedEvents.length} 个事件`, 'success');
                
                // 更新界面
                updateDisplay();
                
            } catch (error) {
                console.error('[CLOUD] 加载云端数据失败:', error);
                updateStatus('❌ 云端数据加载失败，使用本地数据', 'error');
                loadLocalData();
            }
        }

        // 加载本地数据
        function loadLocalData() {
            console.log('[LOCAL] 加载本地数据...');
            requests = JSON.parse(localStorage.getItem('massRequests') || '[]');
            approvedEvents = JSON.parse(localStorage.getItem('approvedEvents') || '[]');
            
            console.log(`[LOCAL] 本地请求: ${requests.length} 个`);
            console.log(`[LOCAL] 本地事件: ${approvedEvents.length} 个`);
            
            updateDisplay();
        }

        // 更新界面显示
        function updateDisplay() {
            console.log('[DISPLAY] 更新界面显示...');
            
            // 更新日历
            const calendarDiv = document.getElementById('calendarDisplay');
            if (approvedEvents.length > 0) {
                let html = '<h3>📅 已批准的事件:</h3>';
                approvedEvents.forEach(event => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>${event.title}</strong><br>
                            日期: ${event.date}<br>
                            内容: ${event.content}
                        </div>
                    `;
                });
                calendarDiv.innerHTML = html;
            } else {
                calendarDiv.innerHTML = '<p>暂无已批准的事件</p>';
            }
            
            // 更新待审核请求
            const pendingDiv = document.getElementById('pendingRequests');
            const pendingRequests = requests.filter(req => req.status === 'pending');
            
            if (pendingRequests.length > 0) {
                let html = '<h3>📋 待审核请求:</h3>';
                pendingRequests.forEach(req => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>${req.arc} - ${req.cohort}</strong><br>
                            内容: ${req.content}<br>
                            提交时间: ${req.submitTime}<br>
                            <button class="btn" onclick="approveRequest('${req.id}')">✅ 批准</button>
                            <button class="btn" style="background: #ef4444;" onclick="rejectRequest('${req.id}')">❌ 拒绝</button>
                        </div>
                    `;
                });
                pendingDiv.innerHTML = html;
            } else {
                pendingDiv.innerHTML = '<p>暂无待审核请求</p>';
            }
            
            // 更新审核记录
            const recordsDiv = document.getElementById('approvedEvents');
            const processedRequests = requests.filter(req => req.status !== 'pending');
            
            if (processedRequests.length > 0) {
                let html = '<h3>📊 审核记录:</h3>';
                processedRequests.forEach(req => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>${req.arc} - ${req.cohort}</strong><br>
                            状态: ${req.status === 'approved' ? '✅ 已批准' : '❌ 已拒绝'}<br>
                            内容: ${req.content}
                        </div>
                    `;
                });
                recordsDiv.innerHTML = html;
            } else {
                recordsDiv.innerHTML = '<p>暂无审核记录</p>';
            }
        }

        // 手动同步
        async function manualSync() {
            console.log('[MANUAL] 手动同步触发');
            updateStatus('🔄 正在手动同步数据...', 'info');
            
            if (collaborationEnabled) {
                await loadCloudData();
            } else {
                loadLocalData();
                updateStatus('💾 本地数据已刷新', 'info');
            }
        }

        // 显示调试信息
        function showDebug() {
            const info = `
=== 调试信息 ===
协同功能: ${collaborationEnabled ? '已启用' : '未启用'}
Supabase: ${supabase ? '已连接' : '未连接'}
请求数量: ${requests.length}
事件数量: ${approvedEvents.length}
            `;
            
            console.log(info);
            alert(info);
        }

        // 测试连接
        async function testConnection() {
            if (!supabase) {
                alert('Supabase未初始化');
                return;
            }
            
            try {
                const { data, error } = await supabase.from('requests').select('count').limit(1);
                if (error) throw error;
                alert('✅ 连接测试成功！');
            } catch (error) {
                alert('❌ 连接测试失败: ' + error.message);
            }
        }

        // 批准请求
        function approveRequest(id) {
            console.log(`[APPROVE] 批准请求: ${id}`);
            // 这里添加批准逻辑
            alert('批准功能开发中...');
        }

        // 拒绝请求
        function rejectRequest(id) {
            console.log(`[REJECT] 拒绝请求: ${id}`);
            // 这里添加拒绝逻辑
            alert('拒绝功能开发中...');
        }

        // 切换标签页
        function showTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            console.log(`[TAB] 切换到: ${tabName}`);
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[PAGE] 页面开始初始化');
            updateStatus('🚀 正在初始化系统...');
            
            // 延迟初始化，确保页面完全加载
            setTimeout(() => {
                initSupabase();
            }, 1000);
        });
    </script>
</body>
</html>
