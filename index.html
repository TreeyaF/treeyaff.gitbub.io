<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCM Blurb 提报 - 测试版</title>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        
        .nav-tabs { display: flex; background: #f8f9fa; }
        .nav-tab { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: #f8f9fa; 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
        }
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active { 
            background: white; 
            border-bottom-color: #007bff; 
        }
        
        .tab-content { 
            display: none; 
            padding: 20px; 
            min-height: 500px;
        }
        .tab-content.active { display: block; }
        
        .calendar-container { margin: 20px 0; }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background: #ddd; 
            border: 1px solid #ddd; 
        }
        .calendar-header { 
            background: #f8f9fa; 
            padding: 10px; 
            text-align: center; 
            font-weight: bold; 
        }
        .calendar-day { 
            background: white; 
            min-height: 100px; 
            padding: 5px; 
            position: relative; 
        }
        .calendar-day.clickable:hover { background: #f0f8ff; }
        .calendar-day.today { background: #e3f2fd; }
        .calendar-day.other-month { opacity: 0.3; }
        
        .event { 
            background: #007bff; 
            color: white; 
            padding: 2px 4px; 
            margin: 1px 0; 
            border-radius: 3px; 
            font-size: 10px; 
        }
        .event.pending { background: #6c757d; }
        
        #userRole {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OCM Blurb 提报 - 测试版</h1>
            
            <!-- 用户角色选择 -->
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px;">
                <label style="color: white; font-weight: bold;">选择您的角色：</label>
                <select id="userRole" onchange="switchUserRole()" style="margin-left: 10px; padding: 5px; border-radius: 3px; border: none;">
                    <option value="requestor">📝 Requestor</option>
                    <option value="ocm_poc">👨‍💼 OCM POC</option>
                </select>
                <span id="roleDescription" style="margin-left: 15px; font-size: 12px; opacity: 0.9;">
                    可以提报请求和查看审核记录
                </span>
            </div>
            
            <div style="margin-top: 10px;">
                <button onclick="testFunction()" style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 12px;">
                    🧪 测试功能
                </button>
                <button onclick="showDebugInfo()" style="background: #6366f1; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    🔍 调试
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button id="calendarTab" class="nav-tab active" onclick="showTab('calendar')">📅 发送日历</button>
            <button id="adminTab" class="nav-tab" onclick="showTab('admin')" style="display: none;">👨‍💼 管理员审核</button>
            <button id="recordsTab" class="nav-tab" onclick="showTab('records')">📊 审核记录</button>
        </div>

        <div id="calendar" class="tab-content active">
            <h2>📅 日历视图</h2>
            <div class="calendar-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button onclick="previousMonth()">&lt; 上月</button>
                    <h3 id="currentMonth">2025年 1月</h3>
                    <button onclick="nextMonth()">下月 &gt;</button>
                </div>
                <div id="calendarGrid" class="calendar-grid">
                    <!-- 日历内容将在这里生成 -->
                </div>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <h2>👥 管理员审核</h2>
            <div id="pendingRequests">
                <p>管理员审核页面</p>
            </div>
        </div>

        <div id="records" class="tab-content">
            <h2>📊 审核记录</h2>
            <div id="approvedEvents">
                <p>审核记录页面</p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentDate = new Date();
        let currentUserRole = 'requestor';
        let isOCMAuthenticated = false;
        
        const OCM_PASSWORD = 'OCM2025';
        
        const ROLES = {
            requestor: {
                name: '📝 Requestor',
                description: '可以提报请求和查看审核记录',
                tabs: ['calendar', 'records']
            },
            ocm_poc: {
                name: '👨‍💼 OCM POC',
                description: '可以审核请求和查看所有内容',
                tabs: ['calendar', 'admin', 'records']
            }
        };

        // 切换用户角色
        function switchUserRole() {
            const roleSelect = document.getElementById('userRole');
            const newRole = roleSelect.value;
            
            console.log(`[PERMISSION] 尝试切换角色: ${currentUserRole} -> ${newRole}`);
            
            if (newRole === 'ocm_poc') {
                // OCM POC需要密码验证
                authenticateOCM((success) => {
                    if (success) {
                        currentUserRole = newRole;
                        isOCMAuthenticated = true;
                        updateUIForRole();
                        alert('OCM POC 认证成功！');
                    } else {
                        // 认证失败，恢复到原角色
                        roleSelect.value = currentUserRole;
                        alert('OCM POC 认证失败！');
                    }
                });
            } else {
                // 切换到Requestor
                currentUserRole = newRole;
                isOCMAuthenticated = false;
                updateUIForRole();
                alert('已切换到 Requestor 角色');
            }
        }

        // OCM POC 认证
        function authenticateOCM(callback) {
            const password = prompt('请输入 OCM POC 密码：');
            
            if (password === null) {
                callback(false);
                return;
            }
            
            if (password === OCM_PASSWORD) {
                callback(true);
            } else {
                alert('密码错误！请联系管理员获取正确密码。');
                callback(false);
            }
        }

        // 根据角色更新界面
        function updateUIForRole() {
            const role = ROLES[currentUserRole];
            
            console.log(`[PERMISSION] 更新界面权限:`, role);
            
            // 更新角色描述
            document.getElementById('roleDescription').textContent = role.description;
            
            // 控制标签页显示
            document.getElementById('calendarTab').style.display = 
                role.tabs.includes('calendar') ? 'block' : 'none';
            document.getElementById('adminTab').style.display = 
                role.tabs.includes('admin') ? 'block' : 'none';
            document.getElementById('recordsTab').style.display = 
                role.tabs.includes('records') ? 'block' : 'none';
            
            // 如果当前标签页不可见，切换到第一个可见标签页
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab && !role.tabs.includes(currentTab.id)) {
                showTab(role.tabs[0]);
            }
        }

        // 显示标签页
        function showTab(tabName) {
            console.log(`[TAB] 切换到标签页: ${tabName}`);
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            // 找到对应的标签按钮并激活
            const tabButton = document.getElementById(tabName + 'Tab');
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }

        // 生成简单日历
        function generateCalendar() {
            const calendar = document.getElementById('calendarGrid');
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            
            document.getElementById('currentMonth').textContent = `${currentDate.getFullYear()}年 ${monthNames[currentDate.getMonth()]}`;
            
            let calendarHTML = '';
            
            // 添加星期标题
            dayNames.forEach(day => {
                calendarHTML += `<div class="calendar-header">${day}</div>`;
            });
            
            // 生成日历格子（简化版）
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate.getTime() + (i * 24 * 60 * 60 * 1000));
                const isCurrentMonth = cellDate.getMonth() === currentDate.getMonth();
                const isToday = cellDate.toDateString() === new Date().toDateString();
                
                let dayClass = 'calendar-day';
                if (!isCurrentMonth) dayClass += ' other-month';
                if (isToday) dayClass += ' today';
                if (isCurrentMonth) dayClass += ' clickable';
                
                calendarHTML += `
                    <div class="${dayClass}">
                        <div style="font-weight: bold;">${cellDate.getDate()}</div>
                        <div class="event">测试事件</div>
                        ${currentUserRole === 'ocm_poc' && isOCMAuthenticated ? 
                            '<button onclick="alert(\'删除功能\')" style="background: red; color: white; border: none; padding: 2px; font-size: 10px;">🗑️</button>' : 
                            '<button style="background: #ccc; border: none; padding: 2px; font-size: 10px;">📋</button>'
                        }
                    </div>
                `;
            }
            
            calendar.innerHTML = calendarHTML;
        }

        // 上月
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        // 下月
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // 测试功能
        function testFunction() {
            console.log('=== 功能测试 ===');
            console.log('当前角色:', currentUserRole);
            console.log('OCM认证:', isOCMAuthenticated);
            console.log('可见标签页:', ROLES[currentUserRole].tabs);
            
            alert(`功能测试：
角色: ${ROLES[currentUserRole].name}
认证: ${isOCMAuthenticated ? '已认证' : '未认证'}
可见标签: ${ROLES[currentUserRole].tabs.join(', ')}`);
        }

        // 显示调试信息
        function showDebugInfo() {
            const info = `=== 调试信息 ===
当前角色: ${ROLES[currentUserRole].name}
OCM认证: ${isOCMAuthenticated ? '已认证' : '未认证'}
可见标签页: ${ROLES[currentUserRole].tabs.join(', ')}`;
            
            console.log(info);
            alert(info);
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[INIT] 页面初始化');
            updateUIForRole();
            generateCalendar();
        });
    </script>
</body>
</html>
